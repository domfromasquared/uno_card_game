<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Online UNO (2-Player)</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #16171b;
      color: #f5f5f5;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 20px;
    }

    .game {
      background: #1f2127;
      border-radius: 12px;
      padding: 20px 24px 28px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      max-width: 900px;
      width: 100%;
      transition: transform 0.2s ease;
    }

    h1 {
      margin-top: 0;
      text-align: center;
      letter-spacing: 1px;
    }

    .top-bar {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    input {
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #111827;
      color: #f9fafb;
      padding: 8px 12px;
      font-size: 0.9rem;
      outline: none;
    }

    input::placeholder {
      color: #6b7280;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      background: #3b82f6;
      color: white;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.9rem;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.2s ease;
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
      background: #2563eb;
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    #status {
      text-align: center;
      margin-bottom: 12px;
      font-size: 0.95rem;
      min-height: 1.5em;
    }

    .board {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin-bottom: 20px;
      align-items: center;
    }

    .pile {
      text-align: center;
    }

    .pile-title {
      margin-bottom: 6px;
      font-size: 0.9rem;
      opacity: 0.7;
    }

    #deckCount {
      font-size: 0.8rem;
      opacity: 0.7;
      margin-top: 4px;
    }

    .card-slot {
      width: 80px;
      height: 120px;
      border-radius: 10px;
      border: 2px dashed #444;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .hand {
      margin-bottom: 16px;
    }

    .hand h2 {
      margin: 8px 0;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .cards-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      min-height: 130px;
      padding: 8px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.02);
    }

    .card {
      width: 70px;
      height: 100px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 1.2rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
      border: 3px solid #f5f5f5;
      box-sizing: border-box;
      position: relative;
      cursor: pointer;
      user-select: none;
      transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
    }

    .card.player-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.6);
      filter: brightness(1.05);
    }

    .card .value {
      text-shadow: 0 2px 3px rgba(0, 0, 0, 0.6);
    }

    .card.action .value {
      font-size: 1rem;
      text-align: center;
      padding: 0 4px;
    }

    .card.red {
      background: #ef4444;
    }

    .card.yellow {
      background: #eab308;
      color: #111827;
    }

    .card.green {
      background: #22c55e;
    }

    .card.blue {
      background: #3b82f6;
    }

    .card.wild {
      background: radial-gradient(
        circle at 10% 20%,
        #ef4444 0,
        #eab308 30%,
        #22c55e 60%,
        #3b82f6 100%
      );
      border-color: #f9fafb;
    }

    .card.back {
      background: linear-gradient(135deg, #111827, #020617);
      border-color: #e5e7eb;
      color: #e5e7eb;
      font-size: 1rem;
      letter-spacing: 1px;
      cursor: default;
    }

    .card.back::before {
      content: "";
      position: absolute;
      inset: 5px;
      border-radius: 8px;
      border: 2px solid #e5e7eb;
      opacity: 0.75;
    }

    .info-line {
      text-align: center;
      font-size: 0.9rem;
      opacity: 0.8;
      margin-bottom: 8px;
    }

    .uno-row {
      display: flex;
      justify-content: center;
      margin-bottom: 8px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .color-picker {
      display: none;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      font-size: 0.9rem;
    }

    .color-btn {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 2px solid #f9fafb;
      padding: 0;
    }

    .color-btn.red {
      background: #ef4444;
    }

    .color-btn.yellow {
      background: #eab308;
    }

    .color-btn.green {
      background: #22c55e;
    }

    .color-btn.blue {
      background: #3b82f6;
    }

    /* Wild +4 impact animation */
    @keyframes wild4Shake {
      0% {
        transform: translate(0, 0) scale(1);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      }
      20% {
        transform: translate(-4px, 2px) scale(1.02);
        box-shadow: 0 14px 35px rgba(0, 0, 0, 0.7);
      }
      40% {
        transform: translate(4px, -2px) scale(1.03);
      }
      60% {
        transform: translate(-3px, 1px) scale(1.02);
      }
      80% {
        transform: translate(3px, -1px) scale(1.01);
      }
      100% {
        transform: translate(0, 0) scale(1);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      }
    }

    .wild4-impact {
      animation: wild4Shake 0.5s ease;
    }

    @media (max-width: 700px) {
      .board {
        flex-direction: column;
        gap: 16px;
      }
      .card {
        width: 58px;
        height: 85px;
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="game">
    <h1>Online UNO (2-Player)</h1>

    <div class="top-bar">
      <button id="createRoomBtn">Create Room</button>
      <input id="roomInput" placeholder="Room code" />
      <button id="joinRoomBtn">Join Room</button>
    </div>

    <div class="info-line">
      Room: <span id="roomCodeLabel">—</span> |
      You: <span id="youAreLabel">—</span>
    </div>

    <div id="status"></div>

    <div class="board">
      <div class="pile">
        <div class="pile-title">Draw pile</div>
        <button id="drawButton" disabled>Draw card</button>
        <div id="deckCount"></div>
      </div>

      <div class="pile">
        <div class="pile-title">Discard pile</div>
        <div id="discardTop" class="card-slot"></div>
      </div>
    </div>

    <div class="uno-row">
      <button id="unoButton" disabled>Yell UNO!</button>
    </div>

    <div id="colorPicker" class="color-picker">
      <span>Choose color:</span>
      <button class="color-btn red" data-color="red" title="Red"></button>
      <button class="color-btn yellow" data-color="yellow" title="Yellow"></button>
      <button class="color-btn green" data-color="green" title="Green"></button>
      <button class="color-btn blue" data-color="blue" title="Blue"></button>
    </div>

    <div class="hand opponent-hand">
      <h2>
        Opponent Hand
        <span>(<span id="opponentCount">0</span> cards)</span>
      </h2>
      <div id="opponentCards" class="cards-row"></div>
    </div>

    <div class="hand player-hand">
      <h2>Your Hand</h2>
      <div id="playerCards" class="cards-row"></div>
    </div>

    <!-- Victory sound -->
    <audio id="victorySound" src="awesome.mp3" preload="auto"></audio>
  </div>

  <script>
    const socket = io();

    let currentRoomCode = null;
    let currentTurn = null;
    let mySocketId = null;
    let pendingWildCardId = null;
    let lastGameOver = false;
    let lastWinner = null;
    let lastWild4CardId = null;

    const statusEl = document.getElementById("status");
    const roomCodeLabel = document.getElementById("roomCodeLabel");
    const youAreLabel = document.getElementById("youAreLabel");
    const deckCountEl = document.getElementById("deckCount");
    const discardTopEl = document.getElementById("discardTop");
    const playerCardsEl = document.getElementById("playerCards");
    const opponentCardsEl = document.getElementById("opponentCards");
    const opponentCountEl = document.getElementById("opponentCount");
    const drawButton = document.getElementById("drawButton");
    const unoButton = document.getElementById("unoButton");
    const colorPicker = document.getElementById("colorPicker");
    const colorButtons = document.querySelectorAll(".color-btn");
    const victorySound = document.getElementById("victorySound");
    const gameEl = document.querySelector(".game");

    function showMessage(msg) {
      statusEl.textContent = msg || "";
    }

    function renderCard(card) {
      const el = document.createElement("div");

      // Decide color class
      let colorClass = card.color;
      if ((card.type === "wild" || card.type === "wild4") && !card.color) {
        colorClass = "wild";
      }

      el.classList.add("card");
      if (colorClass) el.classList.add(colorClass);
      if (card.type !== "number") el.classList.add("action");

      let label;
      if (card.type === "number") {
        label = card.value;
      } else if (card.type === "skip") {
        label = "Skip";
      } else if (card.type === "reverse") {
        label = "Reverse";
      } else if (card.type === "draw2") {
        label = "+2";
      } else if (card.type === "wild") {
        label = "Wild";
      } else if (card.type === "wild4") {
        label = "W+4";
      }

      const span = document.createElement("span");
      span.classList.add("value");
      span.textContent = label;
      el.appendChild(span);
      return el;
    }

    function hideColorPicker() {
      colorPicker.style.display = "none";
      pendingWildCardId = null;
    }

    function handleVictorySound(state) {
      if (
        state.isGameOver &&
        state.winner &&
        (!lastGameOver || state.winner !== lastWinner)
      ) {
        if (victorySound) {
          victorySound.currentTime = 0;
          victorySound.play().catch(() => {
            // autoplay might be blocked; that's fine
          });
        }
      }
      lastGameOver = state.isGameOver;
      lastWinner = state.winner || null;
    }

    function triggerWild4Effect() {
      if (!gameEl) return;
      gameEl.classList.remove("wild4-impact");
      // Force reflow so animation can restart
      void gameEl.offsetWidth;
      gameEl.classList.add("wild4-impact");
      setTimeout(() => {
        gameEl.classList.remove("wild4-impact");
      }, 600);
    }

    function updateUI(state) {
      if (!state) return;

      // Reset any leftover color picker on state update
      hideColorPicker();

      currentRoomCode = state.roomCode;
      currentTurn = state.currentTurn;

      roomCodeLabel.textContent = state.roomCode || "—";
      youAreLabel.textContent = state.youAre || "—";

      deckCountEl.textContent =
        state.deckCount != null
          ? `${state.deckCount} card${state.deckCount === 1 ? "" : "s"} left`
          : "";

      discardTopEl.innerHTML = "";
      if (state.discardTop) {
        const topCardEl = renderCard(state.discardTop);
        discardTopEl.appendChild(topCardEl);

        // Detect new Wild +4 on top and trigger effect
        if (state.discardTop.type === "wild4") {
          if (state.discardTop.id !== lastWild4CardId) {
            lastWild4CardId = state.discardTop.id;
            triggerWild4Effect();
          }
        } else {
          lastWild4CardId = null;
        }
      } else {
        lastWild4CardId = null;
      }

      // Player hand
      playerCardsEl.innerHTML = "";
      const myHand = state.yourHand || [];
      myHand.forEach((card) => {
        const cardEl = renderCard(card);
        cardEl.classList.add("player-card");
        cardEl.addEventListener("click", () => {
          if (!currentRoomCode) return;

          // Wild cards use color picker
          if (card.type === "wild" || card.type === "wild4") {
            pendingWildCardId = card.id;
            colorPicker.style.display = "flex";
            return;
          }

          // Normal cards play immediately
          socket.emit("playCard", {
            roomCode: currentRoomCode,
            cardId: card.id,
            chosenColor: null,
          });
        });
        playerCardsEl.appendChild(cardEl);
      });

      // Opponent (backs only)
      opponentCardsEl.innerHTML = "";
      const oppCount = state.opponentCardCount || 0;
      opponentCountEl.textContent = oppCount.toString();
      for (let i = 0; i < oppCount; i++) {
        const backEl = document.createElement("div");
        backEl.classList.add("card", "back");
        backEl.textContent = "UNO";
        opponentCardsEl.appendChild(backEl);
      }

      const isMyTurn = currentTurn === mySocketId;
      drawButton.disabled = !isMyTurn || state.isGameOver;

      // Enable UNO button if:
      // - game not over
      // - your hand has 2 or fewer cards but > 0
      // - it's your turn
      if (!state.isGameOver && myHand.length <= 2 && myHand.length > 0 && isMyTurn) {
        unoButton.disabled = false;
      } else {
        unoButton.disabled = true;
      }

      if (state.isGameOver) {
        const youWon = state.winner === mySocketId;
        showMessage(youWon ? "You win!" : "Opponent wins.");
      } else if (!currentTurn) {
        showMessage(state.message || "Waiting for players...");
      } else if (isMyTurn) {
        showMessage(state.message || "Your turn");
      } else {
        showMessage(state.message || "Opponent's turn");
      }
    }

    // Buttons
    document.getElementById("createRoomBtn").addEventListener("click", () => {
      socket.emit("createRoom");
    });

    document.getElementById("joinRoomBtn").addEventListener("click", () => {
      const code = document.getElementById("roomInput").value.trim();
      if (!code) {
        showMessage("Enter a room code first.");
        return;
      }
      socket.emit("joinRoom", { roomCode: code });
    });

    drawButton.addEventListener("click", () => {
      if (!currentRoomCode) return;
      socket.emit("drawCard", { roomCode: currentRoomCode });
    });

    unoButton.addEventListener("click", () => {
      if (!currentRoomCode) return;
      socket.emit("yellUno", { roomCode: currentRoomCode });
    });

    // Color picker buttons for wilds
    colorButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const color = btn.dataset.color;
        if (!currentRoomCode || !pendingWildCardId) return;

        socket.emit("playCard", {
          roomCode: currentRoomCode,
          cardId: pendingWildCardId,
          chosenColor: color,
        });

        hideColorPicker();
      });
    });

    // Socket events
    socket.on("connect", () => {
      mySocketId = socket.id;
    });

    socket.on("roomCreated", ({ roomCode, youAre }) => {
      currentRoomCode = roomCode;
      roomCodeLabel.textContent = roomCode;
      youAreLabel.textContent = youAre;
      showMessage(`Room created. Share code: ${roomCode}`);
    });

    socket.on("gameState", (state) => {
      updateUI(state);
      handleVictorySound(state);
    });

    socket.on("errorMessage", (msg) => {
      showMessage(msg);
    });
  </script>
</body>
</html>
