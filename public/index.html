<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Online UNO (2-Player)</title>
  <script src="/socket.io/socket.io.js"></script>

  <style>
    :root{
      --bg:#16171b;
      --panel:#1f2127;
      --accent:#f97316;
      --good:#22c55e;
      --bad:#ef4444;
      --blue:#3b82f6;
    }

    body{
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background: var(--bg);
      color:#f5f5f5;
      margin:0;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      min-height:100vh;
      padding:20px;
    }

    .game{
      position:relative;
      background:var(--panel);
      border-radius:14px;
      padding:20px 24px 28px;
      box-shadow:0 10px 30px rgba(0,0,0,0.5);
      max-width:1100px;
      width:100%;
      overflow:hidden;
    }

    h1{margin-top:0;text-align:center;letter-spacing:1px;}

    .top-bar{
      display:flex;justify-content:center;gap:10px;margin-bottom:12px;flex-wrap:wrap;
    }

    input, select{
      border-radius:999px;border:1px solid #4b5563;background:#111827;color:#f9fafb;
      padding:8px 12px;font-size:0.9rem;outline:none;
    }

    button{
      border-radius:999px;border:none;padding:8px 16px;background:var(--blue);color:white;
      font-weight:900;cursor:pointer;font-size:0.9rem;
      transition:transform 0.12s ease, box-shadow 0.12s ease, background 0.15s ease;
    }

    button:hover:not(:disabled){
      transform:translateY(-1px);
      box-shadow:0 6px 16px rgba(0,0,0,0.4);
      background:#2563eb;
    }

    button:disabled{opacity:0.5;cursor:default;box-shadow:none;transform:none;}

    .info-line{text-align:center;font-size:0.92rem;opacity:0.85;margin-bottom:6px;}
    #status{text-align:center;margin-bottom:10px;font-size:0.98rem;min-height:1.5em;}

    /* Board: make discard huge */
    .board{
      display:flex;
      justify-content:center;
      gap:46px;
      margin-bottom:14px;
      flex-wrap:wrap;
      align-items:flex-start;
    }

    .pile{text-align:center;}
    .pile-title{margin-bottom:8px;font-size:0.9rem;opacity:0.75;}

    /* Big discard slot */
    .discard-slot{
      width:200px;
      height:290px;
      border-radius:16px;
      border:2px dashed rgba(255,255,255,0.25);
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(255,255,255,0.02);
    }

    .deck-slot{
      width:120px;
      height:180px;
      border-radius:16px;
      border:2px dashed rgba(255,255,255,0.25);
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(255,255,255,0.02);
      margin:0 auto 10px;
    }

    #deckCount{font-size:0.85rem;opacity:0.75;margin-top:6px;}

    .uno-row{display:flex;justify-content:center;margin-bottom:8px;gap:8px;flex-wrap:wrap;}

    .color-picker{
      display:none;justify-content:center;align-items:center;gap:10px;margin-bottom:10px;
      font-size:0.95rem;opacity:0.95;
    }

    .color-btn{
      width:34px;height:34px;border-radius:999px;border:2px solid #f9fafb;padding:0;cursor:pointer;
      transition:transform 0.12s ease, filter 0.12s ease, box-shadow 0.12s ease;
    }
    .color-btn.red{background:#ef4444;}
    .color-btn.yellow{background:#eab308;}
    .color-btn.green{background:#22c55e;}
    .color-btn.blue{background:#3b82f6;}

    /* ✅ Hover uses luminance + matching glow (no blue hover) */
    .color-btn:hover{
      transform:translateY(-1px) scale(1.06);
      filter:brightness(1.18) saturate(1.12);
    }
    .color-btn.red:hover{box-shadow:0 0 0 6px rgba(239,68,68,0.28);}
    .color-btn.yellow:hover{box-shadow:0 0 0 6px rgba(234,179,8,0.28);}
    .color-btn.green:hover{box-shadow:0 0 0 6px rgba(34,197,94,0.28);}
    .color-btn.blue:hover{box-shadow:0 0 0 6px rgba(59,130,246,0.28);}

    /* Cards */
    .cards-row{
      display:flex;flex-wrap:wrap;gap:8px;min-height:130px;padding:10px;border-radius:12px;
      background:rgba(255,255,255,0.02);
    }

    .card{
      width:70px;height:100px;border-radius:10px;display:flex;align-items:center;justify-content:center;
      font-weight:1000;font-size:1.2rem;box-shadow:0 4px 10px rgba(0,0,0,0.4);
      border:3px solid #f5f5f5;box-sizing:border-box;user-select:none;
      transition:transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease, opacity 0.15s ease;
    }

    /* Big discard top card */
    .card.large{
      width:160px;
      height:240px;
      border-radius:18px;
      font-size:2.2rem;
      border-width:4px;
      box-shadow:0 14px 30px rgba(0,0,0,0.55);
    }

    .card.player-card{cursor:pointer;}
    .card.player-card:hover{
      transform:translateY(-4px);
      box-shadow:0 8px 16px rgba(0,0,0,0.6);
      filter:brightness(1.05);
    }

    .card.red{background:#ef4444;}
    .card.yellow{background:#eab308;color:#111827;}
    .card.green{background:#22c55e;}
    .card.blue{background:#3b82f6;}
    .card.wild{
      background: radial-gradient(circle at 10% 20%, #ef4444 0, #eab308 30%, #22c55e 60%, #3b82f6 100%);
      border-color:#f9fafb;
    }
    .card.back{
      background: linear-gradient(135deg, #111827, #020617);
      border-color:#e5e7eb;color:#e5e7eb;font-size:1rem;letter-spacing:1px;cursor:default;
    }
    .card.back::before{
      content:"";position:absolute;inset:5px;border-radius:8px;border:2px solid #e5e7eb;opacity:0.75;
    }

    /* Hands + NEW timer border */
    .hand{margin-bottom:14px;}
    .hand h2{margin:10px 0 6px;font-size:1rem;display:flex;align-items:center;justify-content:space-between;}

    .hand-timer{
      height:18px;
      font-size:0.95rem;
      font-weight:900;
      letter-spacing:0.3px;
      opacity:0.95;
      margin:0 0 6px 2px;
    }

    .hand-frame{
      border-radius:16px;
      padding:10px;
      border:3px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.015);
      transition: border-color 0.12s ease, box-shadow 0.12s ease;
    }

    /* We’ll set these dynamically from JS */
    .hand-frame.active{
      border-width:5px;
      box-shadow: 0 0 0 6px rgba(255,255,255,0.05);
    }

    @keyframes wild4Shake{
      0%{transform:translate(0,0) scale(1);}
      20%{transform:translate(-5px,2px) scale(1.02);}
      40%{transform:translate(5px,-2px) scale(1.03);}
      60%{transform:translate(-4px,1px) scale(1.02);}
      80%{transform:translate(4px,-1px) scale(1.01);}
      100%{transform:translate(0,0) scale(1);}
    }
    .wild4-impact{animation:wild4Shake 0.55s ease;}

    @media (max-width:900px){
      .discard-slot{width:170px;height:250px;}
      .card.large{width:140px;height:210px;font-size:2rem;}
    }
    @media (max-width:760px){
      .card{width:58px;height:85px;font-size:1rem;}
      .discard-slot{width:155px;height:225px;}
      .card.large{width:125px;height:190px;font-size:1.7rem;}
    }
  </style>
</head>

<body>
  <div class="game" id="gameRoot">
    <h1>Online UNO (2-Player)</h1>

    <div class="top-bar">
      <button id="createRoomBtn">Create Room</button>

      <input id="roomInput" placeholder="Room code" />
      <button id="joinRoomBtn">Join Room</button>

      <select id="cpuDifficulty">
        <option value="easy">CPU Easy</option>
        <option value="medium">CPU Medium</option>
        <option value="hard">CPU Hard</option>
      </select>
      <button id="playCpuBtn">Play CPU</button>
    </div>

    <div class="info-line">
      Room: <span id="roomCodeLabel">—</span> |
      You: <span id="youAreLabel">—</span> |
      Opponent: <span id="opponentLabel">—</span>
    </div>

    <div id="status"></div>

    <div class="board">
      <div class="pile">
        <div class="pile-title">Draw pile</div>
        <div class="deck-slot" id="deckVisual">
          <button id="drawButton" disabled>Draw</button>
        </div>
        <div id="deckCount"></div>
      </div>

      <div class="pile">
        <div class="pile-title">Discard pile</div>
        <div id="discardTop" class="discard-slot"></div>
      </div>
    </div>

    <div class="uno-row">
      <button id="unoButton" disabled>Yell UNO!</button>
    </div>

    <div id="colorPicker" class="color-picker">
      <span>Choose color:</span>
      <button class="color-btn red" data-color="red" title="Red"></button>
      <button class="color-btn yellow" data-color="yellow" title="Yellow"></button>
      <button class="color-btn green" data-color="green" title="Green"></button>
      <button class="color-btn blue" data-color="blue" title="Blue"></button>
    </div>

    <div class="hand opponent-hand">
      <h2>
        Opponent Hand
        <span>(<span id="opponentCount">0</span> cards)</span>
      </h2>
      <div class="hand-timer" id="oppHandTimer"></div>
      <div class="hand-frame" id="oppFrame">
        <div id="opponentCards" class="cards-row"></div>
      </div>
    </div>

    <div class="hand player-hand">
      <h2>Your Hand</h2>
      <div class="hand-timer" id="myHandTimer"></div>
      <div class="hand-frame" id="myFrame">
        <div id="playerCards" class="cards-row"></div>
      </div>
    </div>

    <!-- WAV sounds -->
    <audio id="soundNewHand" src="new_hand.wav" preload="auto"></audio>
    <audio id="soundWildImpact" src="wild_impact.wav" preload="auto"></audio>
    <audio id="soundWin" src="success_1.wav" preload="auto"></audio>
    <audio id="soundAwesome" src="awesome.wav" preload="auto"></audio>

    <script>
      const socket = io();

      // DOM
      const gameRoot = document.getElementById("gameRoot");
      const statusEl = document.getElementById("status");
      const roomCodeLabel = document.getElementById("roomCodeLabel");
      const youAreLabel = document.getElementById("youAreLabel");
      const opponentLabel = document.getElementById("opponentLabel");

      const deckCountEl = document.getElementById("deckCount");
      const discardTopEl = document.getElementById("discardTop");
      const playerCardsEl = document.getElementById("playerCards");
      const opponentCardsEl = document.getElementById("opponentCards");
      const opponentCountEl = document.getElementById("opponentCount");

      const drawButton = document.getElementById("drawButton");
      const unoButton = document.getElementById("unoButton");

      const colorPicker = document.getElementById("colorPicker");
      const colorButtons = document.querySelectorAll(".color-btn");

      const cpuDiffEl = document.getElementById("cpuDifficulty");
      const myFrame = document.getElementById("myFrame");
      const oppFrame = document.getElementById("oppFrame");
      const myHandTimer = document.getElementById("myHandTimer");
      const oppHandTimer = document.getElementById("oppHandTimer");

      // sounds
      const soundNewHand = document.getElementById("soundNewHand");
      const soundWildImpact = document.getElementById("soundWildImpact");
      const soundWin = document.getElementById("soundWin");
      const soundAwesome = document.getElementById("soundAwesome");

      // Audio unlock
      let audioUnlocked = false;
      async function unlockAudioOnce(){
        if (audioUnlocked) return true;
        try{
          soundNewHand.volume = 0.001;
          soundNewHand.currentTime = 0;
          await soundNewHand.play();
          soundNewHand.pause();
          soundNewHand.currentTime = 0;
          soundNewHand.volume = 1.0;
          audioUnlocked = true;
          return true;
        }catch{
          audioUnlocked = false;
          return false;
        }
      }
      function playSound(audio){
        if(!audioUnlocked) return;
        audio.currentTime = 0;
        audio.play().catch(()=>{});
      }
      window.addEventListener("pointerdown", unlockAudioOnce, { once:true });
      window.addEventListener("keydown", unlockAudioOnce, { once:true });

      // state
      let currentRoomCode = null;
      let mySocketId = null;
      let pendingWildCardId = null;

      // tracking
      let lastGameId = null;
      let dealDoneSentForGameId = null;
      let lastWinner = null;
      let lastGameOver = false;
      let lastEffectKey = null;

      // turn countdown UI
      let activeCountdownInterval = null;
      let latestState = null;

      const TURN_SECONDS = 20;

      // sorting
      const colorOrder = { red:0, yellow:1, green:2, blue:3 };
      const typeOrder  = { number:0, skip:1, reverse:2, draw2:3, wild:4, wild4:5 };
      function sortHand(cards){
        const arr = (cards || []).slice();
        arr.sort((a,b)=>{
          const aWild = a.type === "wild" || a.type === "wild4";
          const bWild = b.type === "wild" || b.type === "wild4";
          if(aWild !== bWild) return aWild ? 1 : -1;

          const ac = colorOrder[a.color] ?? 99;
          const bc = colorOrder[b.color] ?? 99;
          if(ac !== bc) return ac - bc;

          const at = typeOrder[a.type] ?? 99;
          const bt = typeOrder[b.type] ?? 99;
          if(at !== bt) return at - bt;

          const av = a.type === "number" ? (a.value ?? 99) : 99;
          const bv = b.type === "number" ? (b.value ?? 99) : 99;
          if(av !== bv) return av - bv;

          return (a.id ?? 0) - (b.id ?? 0);
        });
        return arr;
      }

      function showMessage(msg){ statusEl.textContent = msg || ""; }

      function renderCard(card, large=false){
        const el = document.createElement("div");
        let cls = card.color;
        if((card.type==="wild" || card.type==="wild4") && !card.color) cls = "wild";
        el.classList.add("card");
        if(large) el.classList.add("large");
        if(cls) el.classList.add(cls);

        let label = "";
        if(card.type==="number") label = card.value;
        else if(card.type==="skip") label = "Skip";
        else if(card.type==="reverse") label = "Rev";
        else if(card.type==="draw2") label = "+2";
        else if(card.type==="wild") label = "Wild";
        else if(card.type==="wild4") label = "+4";
        el.textContent = label;
        return el;
      }

      function renderOpponentBacks(count){
        opponentCardsEl.innerHTML = "";
        for(let i=0;i<count;i++){
          const back = document.createElement("div");
          back.classList.add("card","back");
          back.textContent = "UNO";
          opponentCardsEl.appendChild(back);
        }
        opponentCountEl.textContent = String(count);
      }

      function renderMyHand(cardsSorted, clickable){
        playerCardsEl.innerHTML = "";
        cardsSorted.forEach((card)=>{
          const el = renderCard(card, false);
          if(clickable){
            el.classList.add("player-card");
            el.addEventListener("click", async ()=>{
              await unlockAudioOnce();
              if(!currentRoomCode) return;

              if(card.type === "wild" || card.type === "wild4"){
                pendingWildCardId = card.id;
                colorPicker.style.display = "flex";
                return;
              }
              socket.emit("playCard", { roomCode: currentRoomCode, cardId: card.id, chosenColor: null });
            });
          } else {
            el.style.opacity = "0.92";
            el.style.cursor = "default";
          }
          playerCardsEl.appendChild(el);
        });
      }

      function hideColorPicker(){
        colorPicker.style.display = "none";
        pendingWildCardId = null;
      }

      function triggerWild4Effect(){
        gameRoot.classList.remove("wild4-impact");
        void gameRoot.offsetWidth;
        gameRoot.classList.add("wild4-impact");
        setTimeout(()=>gameRoot.classList.remove("wild4-impact"), 650);
      }

      // Color interpolation green->red by time remaining
      function setActiveBorder(frameEl, timerEl, secondsRemaining){
        const pct = Math.max(0, Math.min(1, secondsRemaining / TURN_SECONDS)); // 1 -> full time, 0 -> expired
        const hue = 120 * pct; // 120=green, 0=red
        const color = `hsl(${hue}, 90%, 50%)`;

        frameEl.classList.add("active");
        frameEl.style.borderColor = color;
        frameEl.style.boxShadow = `0 0 0 6px rgba(255,255,255,0.04), 0 0 0 10px hsla(${hue}, 90%, 50%, 0.15)`;

        timerEl.textContent = `⏱ ${Math.ceil(secondsRemaining)}s`;
        timerEl.style.color = color;
      }

      function clearActiveBorder(frameEl, timerEl){
        frameEl.classList.remove("active");
        frameEl.style.borderColor = "";
        frameEl.style.boxShadow = "";
        timerEl.textContent = "";
        timerEl.style.color = "";
      }

      function stopCountdownLoop(){
        if(activeCountdownInterval){
          clearInterval(activeCountdownInterval);
          activeCountdownInterval = null;
        }
      }

      function startCountdownLoop(){
        stopCountdownLoop();
        activeCountdownInterval = setInterval(() => {
          if(!latestState) return;

          const s = latestState;

          // Clear by default
          clearActiveBorder(myFrame, myHandTimer);
          clearActiveBorder(oppFrame, oppHandTimer);

          if(s.phase !== "playing" || s.isGameOver || !s.currentTurn || !s.lastMoveAt) return;

          const elapsed = (Date.now() - s.lastMoveAt) / 1000;
          const remaining = Math.max(0, TURN_SECONDS - elapsed);

          const isMyTurn = s.currentTurn === mySocketId;

          // If opponent is CPU, still show border on opponent container
          if(isMyTurn){
            setActiveBorder(myFrame, myHandTimer, remaining);
          } else {
            setActiveBorder(oppFrame, oppHandTimer, remaining);
          }
        }, 150);
      }

      async function updateUI(state){
        latestState = state;
        if(!state) return;

        currentRoomCode = state.roomCode;
        roomCodeLabel.textContent = state.roomCode || "—";
        youAreLabel.textContent = state.youAre || "—";

        opponentLabel.textContent = state.opponentIsCpu
          ? `CPU (${state.cpuDifficulty || "easy"})`
          : "Human";

        // Discard big
        discardTopEl.innerHTML = "";
        if(state.discardTop) discardTopEl.appendChild(renderCard(state.discardTop, true));

        deckCountEl.textContent =
          state.deckCount != null ? `${state.deckCount} card${state.deckCount===1?"":"s"} left` : "";

        const myHandSorted = sortHand(state.yourHand || []);
        const myCount = myHandSorted.length;
        const oppCount = state.opponentCardCount || 0;

        const canInteract = state.phase === "playing" && !state.isGameOver;
        const isMyTurn = canInteract && state.currentTurn === mySocketId;

        drawButton.disabled = !isMyTurn;
        unoButton.disabled = !(isMyTurn && myCount > 0 && myCount <= 2);

        showMessage(
          state.isGameOver
            ? (state.winner === mySocketId ? "You win!" : "Opponent wins.")
            : (state.message || "")
        );

        renderOpponentBacks(oppCount);
        renderMyHand(myHandSorted, isMyTurn);

        // Wild4 effect
        const topId = state.discardTop ? state.discardTop.id : null;
        const effectKey = `${state.gameId}|${topId}|${state.specialEffect || ""}`;
        if(effectKey !== lastEffectKey){
          lastEffectKey = effectKey;
          if(state.specialEffect === "wild4"){
            await unlockAudioOnce();
            playSound(soundWildImpact);
            triggerWild4Effect();
          }
        }

        // Deal ack
        if(state.gameId != null && state.gameId !== lastGameId){
          lastGameId = state.gameId;
          dealDoneSentForGameId = null;

          hideColorPicker();

          await unlockAudioOnce();
          playSound(soundNewHand);

          // If you still have your deal animation version, emit dealDone at the end of it.
          // This version acks immediately.
          if(currentRoomCode && dealDoneSentForGameId !== state.gameId){
            dealDoneSentForGameId = state.gameId;
            socket.emit("dealDone", { roomCode: currentRoomCode, gameId: state.gameId });
          }
        }

        // Win sounds
        if(state.isGameOver && state.winner && (!lastGameOver || state.winner !== lastWinner)){
          await unlockAudioOnce();
          const winningCard = state.discardTop;
          if(winningCard && (winningCard.type === "wild" || winningCard.type === "wild4")){
            playSound(soundAwesome);
          }
          if(state.winner === mySocketId){
            playSound(soundWin);
          }
        }

        lastGameOver = state.isGameOver;
        lastWinner = state.winner || null;

        // Ensure countdown loop is running
        startCountdownLoop();
      }

      // UI events
      document.getElementById("createRoomBtn").addEventListener("click", async ()=>{
        await unlockAudioOnce();
        socket.emit("createRoom");
      });

      document.getElementById("joinRoomBtn").addEventListener("click", async ()=>{
        await unlockAudioOnce();
        const code = document.getElementById("roomInput").value.trim();
        if(!code){ showMessage("Enter a room code first."); return; }
        socket.emit("joinRoom", { roomCode: code });
      });

      document.getElementById("playCpuBtn").addEventListener("click", async ()=>{
        await unlockAudioOnce();
        socket.emit("createRoomCpu", { difficulty: cpuDiffEl.value });
      });

      drawButton.addEventListener("click", async ()=>{
        await unlockAudioOnce();
        if(!currentRoomCode) return;
        socket.emit("drawCard", { roomCode: currentRoomCode });
      });

      unoButton.addEventListener("click", async ()=>{
        await unlockAudioOnce();
        if(!currentRoomCode) return;
        socket.emit("yellUno", { roomCode: currentRoomCode });
      });

      colorButtons.forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          await unlockAudioOnce();
          const color = btn.dataset.color;
          if(!currentRoomCode || !pendingWildCardId) return;
          socket.emit("playCard", { roomCode: currentRoomCode, cardId: pendingWildCardId, chosenColor: color });
          hideColorPicker();
        });
      });

      socket.on("connect", ()=> { mySocketId = socket.id; });
      socket.on("roomCreated", ({ roomCode, youAre })=>{
        currentRoomCode = roomCode;
        roomCodeLabel.textContent = roomCode;
        youAreLabel.textContent = youAre;
        showMessage(`Room created. Code: ${roomCode}`);
        lastGameId = null;
        dealDoneSentForGameId = null;
      });

      socket.on("gameState", (state)=> updateUI(state));
      socket.on("errorMessage", (msg)=> showMessage(msg));

      window.addEventListener("beforeunload", stopCountdownLoop);
    </script>
  </div>
</body>
</html>
